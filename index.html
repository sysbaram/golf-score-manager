<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>긴급 수정 - 골프 스코어 관리</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .container {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            max-width: 500px;
            width: 90%;
        }
        h1 { text-align: center; margin-bottom: 2rem; color: #333; }
        .form-group { margin: 1rem 0; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: #555; }
        input { 
            width: 100%; 
            padding: 12px; 
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        input:focus { 
            outline: none; 
            border-color: #667eea; 
        }
        button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            margin: 10px 0;
        }
        button:hover { transform: translateY(-2px); }
        button:disabled { 
            opacity: 0.6; 
            cursor: not-allowed; 
            transform: none;
        }
        .status {
            margin: 1rem 0;
            padding: 1rem;
            border-radius: 8px;
            font-size: 14px;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .debug { 
            background: #f8f9fa; 
            border: 1px solid #dee2e6; 
            font-family: monospace; 
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .tabs {
            display: flex;
            margin-bottom: 1rem;
            border-bottom: 2px solid #e1e5e9;
        }
        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            margin: 0;
        }
        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .tab:hover:not(.active) {
            background: #e9ecef;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .user-info {
            background: #e8f5e8;
            border: 1px solid #c3e6cb;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        .user-info h3 {
            margin: 0 0 0.5rem 0;
            color: #155724;
        }
        .golf-section {
            margin-top: 2rem;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }
        .golf-section h2 {
            margin: 0 0 1.5rem 0;
            color: #495057;
            text-align: center;
        }
        .round-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .round-info input, .round-info select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-size: 14px;
        }
        .holes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        /* 반응형 레이아웃 */
        @media (max-width: 1200px) {
            .holes-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .holes-grid {
                grid-template-columns: 1fr;
            }
            .hole-card {
                padding: 0.75rem;
            }
        }
        .hole-card {
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 1rem;
            background: white;
            position: relative;
        }
        .hole-card.par-3 { border-color: #28a745; background-color: #f8fff8; }
        .hole-card.par-4 { border-color: #ffc107; background-color: #fffbf0; }
        .hole-card.par-5 { border-color: #dc3545; background-color: #fff8f8; }
        
        .hole-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e9ecef;
        }
        .hole-number {
            font-size: 18px;
            font-weight: bold;
            color: #495057;
        }
        .par-selector {
            display: flex;
            gap: 0.25rem;
        }
        .par-btn {
            padding: 0.25rem 0.5rem;
            border: 1px solid #ced4da;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
        }
        .par-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        
        .club-section {
            margin-bottom: 0.75rem;
        }
        .club-title {
            font-size: 12px;
            font-weight: 600;
            color: #6c757d;
            margin-bottom: 0.25rem;
        }
        .club-options {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
        }
        .club-option {
            padding: 0.125rem 0.375rem;
            border: 1px solid #ced4da;
            background: white;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
            font-weight: 500;
            transition: all 0.2s;
        }
        .club-option.selected {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        .club-option:hover:not(.selected) {
            background: #f8f9fa;
        }
        
        /* 아이언 다중 선택 스타일 */
        .iron-multi-selected {
            background: #28a745 !important;
            color: white !important;
            border-color: #28a745 !important;
            position: relative;
        }
        .iron-multi-selected::after {
            content: '✓';
            position: absolute;
            top: -2px;
            right: 2px;
            font-size: 8px;
            font-weight: bold;
        }
        
        .indicators {
            display: flex;
            justify-content: space-between;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid #e9ecef;
        }
        .indicator {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 11px;
        }
        .indicator input[type="checkbox"] {
            width: auto;
            margin: 0;
        }
        
        .hole-total {
            text-align: center;
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: 5px;
            font-weight: bold;
        }
        .hole-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        .hole-save-btn {
            flex: 1;
            padding: 0.375rem;
            font-size: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }
        .hole-save-btn.saved {
            background: #28a745;
            color: white;
        }
        .hole-save-btn:not(.saved) {
            background: #6c757d;
            color: white;
        }
        .score-summary {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 1rem;
            margin: 1rem 0;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        .score-summary div {
            text-align: center;
        }
        .score-summary .label {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 0.25rem;
        }
        .score-summary .value {
            font-size: 16px;
            font-weight: 600;
            color: #495057;
        }
        .summary-section {
            margin: 1.5rem 0;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        .summary-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 1rem;
            color: #495057;
            text-align: center;
        }
        .front-nine, .back-nine {
            margin-bottom: 1rem;
        }
        .nine-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #495057;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🏌️ 골프 스코어 관리</h1>
        
        <!-- 로그인된 사용자 정보 표시 영역 -->
                <div id="user-info" class="user-info" style="display: none;">
            <h3>👋 환영합니다!</h3>
            <p><strong>사용자:</strong> <span id="current-username"></span></p>
            <p><strong>이메일:</strong> <span id="current-email"></span></p>
            <button onclick="logout()" style="background: #dc3545; width: auto; padding: 8px 16px;">로그아웃</button>
                    </div>
        
        <!-- 골프 스코어 입력 섹션 (로그인된 사용자만 표시) -->
        <div id="golf-section" class="golf-section" style="display: none;">
            <h2>⛳ 골프 스코어 입력</h2>
            
            <!-- 라운드 정보 -->
            <div class="round-info">
                <div>
                    <label for="golf-course">골프장명</label>
                    <input type="text" id="golf-course" placeholder="골프장명을 입력하세요" value="샘플 골프클럽">
                </div>
                <div>
                    <label for="play-date">플레이 날짜</label>
                    <input type="date" id="play-date">
                    </div>
                <div>
                    <label for="tee-box">티박스</label>
                    <select id="tee-box">
                        <option value="레드">레드 티</option>
                        <option value="화이트" selected>화이트 티</option>
                        <option value="블루">블루 티</option>
                        <option value="블랙">블랙 티</option>
                    </select>
                    </div>
                <div>
                    <label for="weather">날씨</label>
                    <select id="weather">
                        <option value="맑음" selected>맑음</option>
                        <option value="흐림">흐림</option>
                        <option value="비">비</option>
                        <option value="바람">바람</option>
                    </select>
            </div>
        </div>

            <!-- 전반 9홀 -->
            <div class="summary-section">
                <div class="summary-title">🏌️ 전반 9홀 (Front Nine)</div>
                <div class="holes-grid" id="front-nine-grid">
                    <!-- JavaScript로 동적 생성 -->
                </div>
                
                <!-- 전반 요약 -->
                <div class="score-summary" id="front-summary">
                    <div>
                        <div class="label">정규타수</div>
                        <div class="value" id="front-par">36</div>
                    </div>
                    <div>
                        <div class="label">스코어</div>
                        <div class="value" id="front-score">0</div>
                    </div>
                    <div>
                        <div class="label">파 대비</div>
                        <div class="value" id="front-diff">E</div>
                    </div>
                    <div>
                        <div class="label">R/O</div>
                        <div class="value" id="front-ro">0</div>
                    </div>
                    <div>
                        <div class="label">2Put</div>
                        <div class="value" id="front-2put">0</div>
                    </div>
                    <div>
                        <div class="label">저장됨</div>
                        <div class="value" id="front-saved">0/9</div>
                    </div>
                </div>
            </div>
            
            <!-- 후반 9홀 -->
            <div class="summary-section">
                <div class="summary-title">🏌️ 후반 9홀 (Back Nine)</div>
                <div class="holes-grid" id="back-nine-grid">
                    <!-- JavaScript로 동적 생성 -->
                </div>
                
                <!-- 후반 요약 -->
                <div class="score-summary" id="back-summary">
                    <div>
                        <div class="label">정규타수</div>
                        <div class="value" id="back-par">36</div>
                    </div>
                    <div>
                        <div class="label">스코어</div>
                        <div class="value" id="back-score">0</div>
                    </div>
                    <div>
                        <div class="label">파 대비</div>
                        <div class="value" id="back-diff">E</div>
                    </div>
                    <div>
                        <div class="label">R/O</div>
                        <div class="value" id="back-ro">0</div>
                    </div>
                    <div>
                        <div class="label">2Put</div>
                        <div class="value" id="back-2put">0</div>
                    </div>
                    <div>
                        <div class="label">저장됨</div>
                        <div class="value" id="back-saved">0/9</div>
                    </div>
                </div>
            </div>
            
            <!-- 18홀 전체 요약 -->
            <div class="summary-section">
                <div class="summary-title">📊 18홀 전체 요약</div>
                <div class="score-summary" id="total-summary">
                    <div>
                        <div class="label">정규타수</div>
                        <div class="value" id="total-par">72</div>
                    </div>
                    <div>
                        <div class="label">스코어</div>
                        <div class="value" id="total-score">0</div>
                    </div>
                    <div>
                        <div class="label">파 대비</div>
                        <div class="value" id="total-diff">E</div>
                    </div>
                    <div>
                        <div class="label">R/O</div>
                        <div class="value" id="total-ro">0</div>
                    </div>
                    <div>
                        <div class="label">2Put</div>
                        <div class="value" id="total-2put">0</div>
                    </div>
                    <div>
                        <div class="label">저장됨</div>
                        <div class="value" id="total-saved">0/18</div>
                    </div>
                </div>
            </div>
            
            <!-- 저장 버튼 -->
            <button onclick="saveGolfScore()" id="save-score-btn" style="margin-top: 1rem;">스코어 저장</button>
        </div>

        <!-- 로그인/회원가입 탭 -->
        <div id="auth-section">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('login')">로그인</button>
                <button class="tab" onclick="switchTab('register')">회원가입</button>
        </div>

            <!-- 로그인 탭 -->
            <div id="login-tab" class="tab-content active">
                    <div class="form-group">
                    <label for="login-email">이메일</label>
                    <input type="email" id="login-email" placeholder="이메일을 입력하세요" value="test6@example.com">
                    </div>
                
                    <div class="form-group">
                        <label for="login-password">비밀번호</label>
                    <input type="password" id="login-password" placeholder="비밀번호를 입력하세요" value="password123">
        </div>

                <button onclick="loginUser()" id="login-btn">로그인</button>
                </div>

            <!-- 회원가입 탭 -->
            <div id="register-tab" class="tab-content">
                    <div class="form-group">
                        <label for="register-username">사용자명</label>
                    <input type="text" id="register-username" placeholder="사용자명을 입력하세요" value="testuser7">
                    </div>

                    <div class="form-group">
                        <label for="register-email">이메일</label>
                    <input type="email" id="register-email" placeholder="이메일을 입력하세요" value="test7@example.com">
                    </div>

                    <div class="form-group">
                        <label for="register-password">비밀번호</label>
                    <input type="password" id="register-password" placeholder="비밀번호를 입력하세요" value="password123">
                    </div>
                
                <button onclick="registerUser()" id="register-btn">회원가입</button>
                    </div>
                    </div>

        <!-- 관리자 버튼들 -->
        <div style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #e1e5e9;">
            <button onclick="checkStatus()" style="background: #6c757d;">상태 확인</button>
            <button onclick="forceInit()" style="background: #dc3545;">강제 초기화</button>
            </div>

        <div id="status" class="status info">
            🔄 시스템 로딩 중... 잠시만 기다려주세요.
        </div>
    </div>

    <script>
        // 전역 변수
        let isReady = false;
        let initAttempts = 0;
        let currentUser = null; // 현재 로그인된 사용자
        
        const CLIENT_ID = '38824619592-npt5ckpvnqjleo82j7onsrvqi7r39q0h.apps.googleusercontent.com';
        const SCOPE = 'https://www.googleapis.com/auth/spreadsheets';
        const SPREADSHEET_ID = '1-8URFWExJVHp-V3bnB-zFtBaxMZUZ5QKvvEVo0CGz10';
        
        // 상태 표시 함수
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.innerHTML = message;
            console.log(`[${type.toUpperCase()}]`, message.replace(/<[^>]*>/g, ''));
        }
        
        // 탭 전환 함수
        function switchTab(tabName) {
            // 모든 탭 비활성화
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // 선택된 탭 활성화
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }
        
        // 사용자 UI 업데이트
        function updateUserUI(user) {
            if (user) {
                // 로그인된 상태
                document.getElementById('user-info').style.display = 'block';
                document.getElementById('golf-section').style.display = 'block';
                document.getElementById('auth-section').style.display = 'none';
                document.getElementById('current-username').textContent = user.username;
                document.getElementById('current-email').textContent = user.email;
                currentUser = user;
                
                // 골프 스코어 입력 폼 초기화
                initializeGolfScoreForm();
                
                showStatus(`✅ ${user.username}님, 환영합니다!`, 'success');
            } else {
                // 로그아웃된 상태
                document.getElementById('user-info').style.display = 'none';
                document.getElementById('golf-section').style.display = 'none';
                document.getElementById('auth-section').style.display = 'block';
                currentUser = null;
            }
        }
        
        // 로그아웃 함수
        function logout() {
            updateUserUI(null);
            showStatus('✅ 로그아웃되었습니다.', 'info');
        }
        
        // 골프 스코어 폼 초기화
        function initializeGolfScoreForm() {
            // 오늘 날짜 설정
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('play-date').value = today;
            
            // 18홀 입력 필드 생성
            createHoleInputs();
            
            // 스코어 계산 이벤트 리스너 추가
            addScoreEventListeners();
        }
        
        // 골프 스코어 데이터 저장
        let golfScoreData = {};
        
        // 홀 입력 필드 생성
        function createHoleInputs() {
            // 표준 파 설정 (일반적인 골프장 파 구성)
            const standardPars = [4, 4, 3, 5, 4, 3, 4, 4, 5, 4, 3, 4, 5, 4, 3, 4, 4, 5];
            
            // 전반 9홀
            const frontGrid = document.getElementById('front-nine-grid');
            frontGrid.innerHTML = '';
            for (let i = 1; i <= 9; i++) {
                const par = standardPars[i - 1];
                frontGrid.appendChild(createHoleCard(i, par));
                initializeHoleData(i, par);
            }
            
            // 후반 9홀
            const backGrid = document.getElementById('back-nine-grid');
            backGrid.innerHTML = '';
            for (let i = 10; i <= 18; i++) {
                const par = standardPars[i - 1];
                backGrid.appendChild(createHoleCard(i, par));
                initializeHoleData(i, par);
            }
        }
        
        // 홀 데이터 초기화
        function initializeHoleData(holeNumber, par) {
            golfScoreData[holeNumber] = {
                par: par,
                driver: null,
                wood: null,
                iron: [], // 아이언은 배열로 변경 (다중 선택)
                putter: null,
                regularOn: false,
                twoPut: false,
                totalScore: 0,
                saved: false
            };
        }
        
        // 홀 카드 생성
        function createHoleCard(holeNumber, defaultPar) {
            const holeCard = document.createElement('div');
            holeCard.className = `hole-card par-${defaultPar}`;
            holeCard.id = `hole-card-${holeNumber}`;
            
            holeCard.innerHTML = `
                <div class="hole-header">
                    <div class="hole-number">홀 ${holeNumber}</div>
                    <div class="par-selector">
                        <button type="button" class="par-btn ${defaultPar === 3 ? 'active' : ''}" onclick="setPar(${holeNumber}, 3)">Par 3</button>
                        <button type="button" class="par-btn ${defaultPar === 4 ? 'active' : ''}" onclick="setPar(${holeNumber}, 4)">Par 4</button>
                        <button type="button" class="par-btn ${defaultPar === 5 ? 'active' : ''}" onclick="setPar(${holeNumber}, 5)">Par 5</button>
                    </div>
                </div>
                
                <div class="club-section">
                    <div class="club-title">🏌️ Driver</div>
                    <div class="club-options">
                        <div class="club-option" data-club="driver" data-value="G/S" data-score="1" onclick="selectClubOption(${holeNumber}, 'driver', 'G/S', 1)">G/S</div>
                        <div class="club-option" data-club="driver" data-value="O/B" data-score="3" onclick="selectClubOption(${holeNumber}, 'driver', 'O/B', 3)">O/B</div>
                        <div class="club-option" data-club="driver" data-value="P/A" data-score="2" onclick="selectClubOption(${holeNumber}, 'driver', 'P/A', 2)">P/A</div>
                    </div>
                </div>
                
                <div class="club-section">
                    <div class="club-title">🌳 Wood/UT</div>
                    <div class="club-options">
                        <div class="club-option" data-club="wood" data-value="UT2" data-score="1" onclick="selectClubOption(${holeNumber}, 'wood', 'UT2', 1)">UT2</div>
                        <div class="club-option" data-club="wood" data-value="O/B" data-score="3" onclick="selectClubOption(${holeNumber}, 'wood', 'O/B', 3)">O/B</div>
                        <div class="club-option" data-club="wood" data-value="P/A" data-score="2" onclick="selectClubOption(${holeNumber}, 'wood', 'P/A', 2)">P/A</div>
                    </div>
                </div>
                
                <div class="club-section">
                    <div class="club-title">⚡ Iron (다중 선택 가능)</div>
                    <div class="club-options">
                        <div class="club-option" data-club="iron" data-value="3" data-score="1" onclick="selectIronOption(${holeNumber}, '3', 1)">3</div>
                        <div class="club-option" data-club="iron" data-value="4" data-score="1" onclick="selectIronOption(${holeNumber}, '4', 1)">4</div>
                        <div class="club-option" data-club="iron" data-value="5" data-score="1" onclick="selectIronOption(${holeNumber}, '5', 1)">5</div>
                        <div class="club-option" data-club="iron" data-value="6" data-score="1" onclick="selectIronOption(${holeNumber}, '6', 1)">6</div>
                        <div class="club-option" data-club="iron" data-value="7" data-score="1" onclick="selectIronOption(${holeNumber}, '7', 1)">7</div>
                        <div class="club-option" data-club="iron" data-value="8" data-score="1" onclick="selectIronOption(${holeNumber}, '8', 1)">8</div>
                        <div class="club-option" data-club="iron" data-value="9" data-score="1" onclick="selectIronOption(${holeNumber}, '9', 1)">9</div>
                        <div class="club-option" data-club="iron" data-value="52" data-score="1" onclick="selectIronOption(${holeNumber}, '52', 1)">52</div>
                        <div class="club-option" data-club="iron" data-value="56" data-score="1" onclick="selectIronOption(${holeNumber}, '56', 1)">56</div>
                        <div class="club-option" data-club="iron" data-value="O/B" data-score="3" onclick="selectIronOption(${holeNumber}, 'O/B', 3)">O/B</div>
                        <div class="club-option" data-club="iron" data-value="P/A" data-score="2" onclick="selectIronOption(${holeNumber}, 'P/A', 2)">P/A</div>
                    </div>
                </div>
                
                <div class="club-section">
                    <div class="club-title">🥅 Putter</div>
                    <div class="club-options">
                        <div class="club-option" data-club="putter" data-value="1" data-score="1" onclick="selectClubOption(${holeNumber}, 'putter', '1', 1)">1</div>
                        <div class="club-option" data-club="putter" data-value="2" data-score="2" onclick="selectClubOption(${holeNumber}, 'putter', '2', 2)">2</div>
                        <div class="club-option" data-club="putter" data-value="3" data-score="3" onclick="selectClubOption(${holeNumber}, 'putter', '3', 3)">3</div>
                        <div class="club-option" data-club="putter" data-value="4" data-score="4" onclick="selectClubOption(${holeNumber}, 'putter', '4', 4)">4</div>
                    </div>
                </div>
                
                <div class="indicators">
                    <div class="indicator">
                        <input type="checkbox" id="ro-${holeNumber}" onchange="toggleIndicator(${holeNumber}, 'regularOn', this.checked)">
                        <label for="ro-${holeNumber}">R/O</label>
                    </div>
                    <div class="indicator">
                        <input type="checkbox" id="2put-${holeNumber}" disabled>
                        <label for="2put-${holeNumber}">2Put</label>
                    </div>
                </div>
                
                <div class="hole-total" id="hole-total-${holeNumber}">
                    총 스코어: 0
                </div>
                
                <div class="hole-actions">
                    <button type="button" class="hole-save-btn" id="hole-save-${holeNumber}" onclick="saveHoleScore(${holeNumber})">저장</button>
                </div>
            `;
            
            return holeCard;
        }
        
        // 스코어 계산 이벤트 리스너 추가
        function addScoreEventListeners() {
            // 새로운 시스템에서는 클럽별 선택으로 자동 계산되므로 별도 리스너 불필요
        }
        
        // 파 설정
        function setPar(holeNumber, par) {
            // 기존 파 버튼 비활성화
            const holeCard = document.getElementById(`hole-card-${holeNumber}`);
            const parBtns = holeCard.querySelectorAll('.par-btn');
            parBtns.forEach(btn => btn.classList.remove('active'));
            
            // 새 파 버튼 활성화
            event.target.classList.add('active');
            
            // 데이터 업데이트
            golfScoreData[holeNumber].par = par;
            
            // 홀 카드 클래스 업데이트
            holeCard.className = `hole-card par-${par}`;
            
            // 스코어 재계산
            calculateHoleScore(holeNumber);
            updateSummaries();
        }
        
        // 클럽 옵션 선택 (Driver, Wood, Putter용) - 토글 기능 포함
        function selectClubOption(holeNumber, clubType, value, score) {
            const holeCard = document.getElementById(`hole-card-${holeNumber}`);
            const clickedOption = event.target;
            const clubOptions = holeCard.querySelectorAll(`[data-club="${clubType}"]`);
            
            // 이미 선택된 옵션을 다시 클릭한 경우 - 선택 해제 (토글)
            if (clickedOption.classList.contains('selected')) {
                clickedOption.classList.remove('selected');
                golfScoreData[holeNumber][clubType] = null;
                
                // 퍼터 해제 시 2Put도 해제
                if (clubType === 'putter') {
                    const twoPutCheckbox = document.getElementById(`2put-${holeNumber}`);
                    twoPutCheckbox.checked = false;
                    golfScoreData[holeNumber].twoPut = false;
                }
            } else {
                // 새로운 옵션 선택 - 다른 옵션들 비활성화 후 선택
                clubOptions.forEach(option => option.classList.remove('selected'));
                clickedOption.classList.add('selected');
                
                // 데이터 업데이트
                golfScoreData[holeNumber][clubType] = {
                    value: value,
                    score: score
                };
                
                // 2Put 자동 체크 (퍼터가 2 이하인 경우)
                if (clubType === 'putter') {
                    const twoPutCheckbox = document.getElementById(`2put-${holeNumber}`);
                    const twoPut = score <= 2;
                    twoPutCheckbox.checked = twoPut;
                    golfScoreData[holeNumber].twoPut = twoPut;
                }
            }
            
            // 홀 스코어 계산
            calculateHoleScore(holeNumber);
            updateSummaries();
        }
        
        // 아이언 다중 선택 함수
        function selectIronOption(holeNumber, value, score) {
            const holeCard = document.getElementById(`hole-card-${holeNumber}`);
            const clickedOption = event.target;
            const holeData = golfScoreData[holeNumber];
            
            // 현재 선택된 아이언 목록에서 해당 값 찾기
            const existingIndex = holeData.iron.findIndex(iron => iron.value === value);
            
            if (existingIndex >= 0) {
                // 이미 선택된 경우 - 선택 해제
                holeData.iron.splice(existingIndex, 1);
                clickedOption.classList.remove('iron-multi-selected');
            } else {
                // 새로 선택하는 경우 - 추가
                holeData.iron.push({
                    value: value,
                    score: score
                });
                clickedOption.classList.add('iron-multi-selected');
            }
            
            // 홀 스코어 계산
            calculateHoleScore(holeNumber);
            updateSummaries();
        }
        
        // 지표 토글
        function toggleIndicator(holeNumber, indicator, checked) {
            golfScoreData[holeNumber][indicator] = checked;
            updateSummaries();
        }
        
        // 홀 스코어 계산
        function calculateHoleScore(holeNumber) {
            const holeData = golfScoreData[holeNumber];
            let totalScore = 0;
            
            // 각 클럽별 스코어 합산
            if (holeData.driver) totalScore += holeData.driver.score;
            if (holeData.wood) totalScore += holeData.wood.score;
            
            // 아이언은 배열이므로 모든 선택된 아이언의 스코어 합산
            if (holeData.iron && holeData.iron.length > 0) {
                holeData.iron.forEach(iron => {
                    totalScore += iron.score;
                });
            }
            
            if (holeData.putter) totalScore += holeData.putter.score;
            
            holeData.totalScore = totalScore;
            
            // UI 업데이트
            const totalElement = document.getElementById(`hole-total-${holeNumber}`);
            if (totalScore > 0) {
                const parDiff = totalScore - holeData.par;
                let parText = '';
                if (parDiff > 0) {
                    parText = ` (+${parDiff})`;
                } else if (parDiff < 0) {
                    parText = ` (${parDiff})`;
                } else {
                    parText = ' (E)';
                }
                
                // 아이언 선택 개수 표시
                const ironCount = holeData.iron.length;
                const ironText = ironCount > 0 ? ` [Iron: ${ironCount}개]` : '';
                
                totalElement.textContent = `총 스코어: ${totalScore}${parText}${ironText}`;
                totalElement.style.color = parDiff < 0 ? '#28a745' : parDiff > 0 ? '#dc3545' : '#495057';
            } else {
                totalElement.textContent = '총 스코어: 0';
                totalElement.style.color = '#495057';
            }
        }
        
        // 홀별 스코어 저장
        async function saveHoleScore(holeNumber) {
            const holeData = golfScoreData[holeNumber];
            const saveBtn = document.getElementById(`hole-save-${holeNumber}`);
            
            try {
                if (!currentUser) {
                    showStatus('❌ 로그인이 필요합니다.', 'error');
                    return;
                }
                
                if (holeData.totalScore === 0) {
                    showStatus('❌ 스코어를 입력해주세요.', 'error');
                    return;
                }
                
                // 시스템 준비 확인
                if (!isReady) {
                    showStatus('⚠️ 시스템이 준비되지 않았습니다. 강제 초기화를 시도합니다...', 'info');
                    await forceInit();
                    
                    if (!isReady) {
                        throw new Error('시스템 초기화에 실패했습니다.');
                    }
                }
                
                saveBtn.disabled = true;
                saveBtn.textContent = '저장 중...';
                
                // OAuth 토큰 요청
                const tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPE,
                    callback: async (tokenResponse) => {
                        if (tokenResponse.access_token) {
                            try {
                                gapi.client.setToken({ access_token: tokenResponse.access_token });
                                
                                // 라운드 정보
                                const golfCourse = document.getElementById('golf-course').value.trim();
                                const playDate = document.getElementById('play-date').value;
                                const teeBox = document.getElementById('tee-box').value;
                                const weather = document.getElementById('weather').value;
                                
                                // 아이언 데이터 처리 (다중 선택)
                                const ironValues = holeData.iron.map(iron => iron.value).join(', ');
                                const ironTotalScore = holeData.iron.reduce((sum, iron) => sum + iron.score, 0);
                                
                                // 홀별 상세 데이터 준비
                                const holeScoreData = [
                                    currentUser.username,
                                    currentUser.email,
                                    playDate || new Date().toISOString().split('T')[0],
                                    golfCourse || '미입력',
                                    teeBox,
                                    weather,
                                    holeNumber,
                                    holeData.par,
                                    holeData.driver ? holeData.driver.value : '',
                                    holeData.driver ? holeData.driver.score : 0,
                                    holeData.wood ? holeData.wood.value : '',
                                    holeData.wood ? holeData.wood.score : 0,
                                    ironValues, // 다중 선택된 아이언들
                                    ironTotalScore, // 아이언 총 스코어
                                    holeData.putter ? holeData.putter.value : '',
                                    holeData.putter ? holeData.putter.score : 0,
                                    holeData.totalScore,
                                    holeData.regularOn ? 1 : 0,
                                    holeData.twoPut ? 1 : 0,
                                    new Date().toISOString()
                                ];
                                
                                // HoleScores 시트에 헤더 확인 및 생성
                                console.log(`📝 홀 ${holeNumber} 저장 데이터:`, holeScoreData);
                                await ensureHoleScoresSheetHeaders();
                                
                                // 기존 데이터 확인 (중복 방지)
                                console.log(`🔍 홀 ${holeNumber} 기존 데이터 확인 중...`);
                                const existingRowIndex = await findExistingHoleScore(currentUser.username, currentUser.email, playDate || new Date().toISOString().split('T')[0], holeNumber);
                                
                                let response;
                                if (existingRowIndex > 0) {
                                    // 기존 데이터 업데이트
                                    console.log(`🔄 홀 ${holeNumber} 기존 데이터 업데이트 (행: ${existingRowIndex})`);
                                    response = await gapi.client.sheets.spreadsheets.values.update({
                                        spreadsheetId: SPREADSHEET_ID,
                                        range: `HoleScores!A${existingRowIndex}:T${existingRowIndex}`,
                                        valueInputOption: 'USER_ENTERED',
                                        resource: {
                                            values: [holeScoreData]
                                        }
                                    });
                                    console.log(`✅ 홀 ${holeNumber} 스코어 업데이트 완료:`, response);
                                } else {
                                    // 새 데이터 추가
                                    console.log(`📤 홀 ${holeNumber} 새 데이터 추가 중...`);
                                    response = await gapi.client.sheets.spreadsheets.values.append({
                                        spreadsheetId: SPREADSHEET_ID,
                                        range: 'HoleScores!A:T',
                                        valueInputOption: 'USER_ENTERED',
                                        resource: {
                                            values: [holeScoreData]
                                        }
                                    });
                                    console.log(`✅ 홀 ${holeNumber} 스코어 저장 완료:`, response);
                                }
                                
                                // 응답 검증
                                if (response && response.result) {
                                    if (response.result.updates) {
                                        console.log(`📊 처리된 행 수: ${response.result.updates.updatedRows || response.result.updates.updatedCells}`);
                                    } else if (response.result.updatedRows) {
                                        console.log(`📊 업데이트된 행 수: ${response.result.updatedRows}`);
                                    }
                                } else {
                                    console.warn('⚠️ 응답 구조가 예상과 다릅니다:', response);
                                }
                                
                                // 저장 완료 표시
                                holeData.saved = true;
                                saveBtn.classList.add('saved');
                                saveBtn.textContent = '저장됨';
                                
                                // 성공 메시지 (업데이트/신규에 따라 다르게 표시)
                                const actionText = existingRowIndex > 0 ? '업데이트' : '저장';
                                showStatus(`✅ 홀 ${holeNumber} 스코어 ${actionText} 완료! (${holeData.totalScore}타)`, 'success');
                                
                                // 요약 업데이트
                                updateSummaries();
                                
                            } catch (sheetsError) {
                                console.error(`❌ 홀 ${holeNumber} 스코어 저장 오류:`, sheetsError);
                                showStatus(`❌ 홀 ${holeNumber} 저장 실패: ${sheetsError.message}`, 'error');
                            }
                        } else {
                            showStatus('❌ Google 로그인 실패', 'error');
                        }
                        
                        saveBtn.disabled = false;
                        if (!holeData.saved) {
                            saveBtn.textContent = '저장';
                        }
                    }
                });
                
                tokenClient.requestAccessToken({ prompt: 'consent' });
                
            } catch (error) {
                console.error(`❌ 홀 ${holeNumber} 저장 실패:`, error);
                showStatus(`❌ 홀 ${holeNumber} 저장 실패: ${error.message}`, 'error');
                saveBtn.disabled = false;
                saveBtn.textContent = '저장';
            }
        }
        
        // HoleScores 시트 헤더 확인 및 생성
        async function ensureHoleScoresSheetHeaders() {
            try {
                console.log('🔍 HoleScores 시트 헤더 확인 중...');
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'HoleScores!A1:T1'
                });
                
                console.log('📋 HoleScores 헤더 응답:', response);
                const values = response.result.values;
                
                if (!values || values.length === 0) {
                    console.log('📋 HoleScores 시트 헤더가 없습니다. 생성 중...');
                    
                    const headers = [
                        'Username', 'Email', 'Play Date', 'Golf Course', 'Tee Box', 'Weather',
                        'Hole Number', 'Par', 
                        'Driver Value', 'Driver Score', 
                        'Wood Value', 'Wood Score',
                        'Iron Values', 'Iron Total Score',
                        'Putter Value', 'Putter Score',
                        'Total Score', 'Regular On', '2 Put', 'Created At'
                    ];
                    
                    console.log('📝 헤더 생성 중:', headers);
                    const headerResponse = await gapi.client.sheets.spreadsheets.values.update({
                        spreadsheetId: SPREADSHEET_ID,
                        range: 'HoleScores!A1:T1',
                        valueInputOption: 'USER_ENTERED',
                        resource: {
                            values: [headers]
                        }
                    });
                    
                    console.log('✅ HoleScores 시트 헤더 생성 완료:', headerResponse);
                } else {
                    console.log('✅ HoleScores 시트 헤더 이미 존재:', values[0]);
                }
            } catch (error) {
                console.error('❌ HoleScores 시트 헤더 처리 중 오류:', error);
                
                // 시트가 존재하지 않는 경우 시트 생성 시도
                if (error.status === 400 && error.result && error.result.error && 
                    error.result.error.message.includes('Unable to parse range')) {
                    console.log('🆕 HoleScores 시트가 존재하지 않습니다. 시트 생성을 시도합니다...');
                    await createHoleScoresSheet();
                } else {
                    throw error; // 다른 오류는 상위로 전파
                }
            }
        }
        
        // HoleScores 시트 생성
        async function createHoleScoresSheet() {
            try {
                console.log('🆕 HoleScores 시트 생성 중...');
                
                // 시트 추가
                const addSheetResponse = await gapi.client.sheets.spreadsheets.batchUpdate({
                    spreadsheetId: SPREADSHEET_ID,
                    resource: {
                        requests: [{
                            addSheet: {
                                properties: {
                                    title: 'HoleScores'
                                }
                            }
                        }]
                    }
                });
                
                console.log('✅ HoleScores 시트 생성 완료:', addSheetResponse);
                
                // 헤더 추가
                const headers = [
                    'Username', 'Email', 'Play Date', 'Golf Course', 'Tee Box', 'Weather',
                    'Hole Number', 'Par', 
                    'Driver Value', 'Driver Score', 
                    'Wood Value', 'Wood Score',
                    'Iron Values', 'Iron Total Score',
                    'Putter Value', 'Putter Score',
                    'Total Score', 'Regular On', '2 Put', 'Created At'
                ];
                
                const headerResponse = await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'HoleScores!A1:T1',
                    valueInputOption: 'USER_ENTERED',
                    resource: {
                        values: [headers]
                    }
                });
                
                console.log('✅ HoleScores 시트 헤더 추가 완료:', headerResponse);
                
            } catch (createError) {
                console.error('❌ HoleScores 시트 생성 실패:', createError);
                throw createError;
            }
        }
        
        // 기존 홀 스코어 찾기 (중복 방지용)
        async function findExistingHoleScore(username, email, playDate, holeNumber) {
            try {
                console.log(`🔍 기존 데이터 검색: ${username}, ${email}, ${playDate}, 홀 ${holeNumber}`);
                
                // 전체 데이터 가져오기
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'HoleScores!A:G' // Username, Email, Play Date, Golf Course, Tee Box, Weather, Hole Number까지
                });
                
                const rows = response.result.values || [];
                console.log(`📊 총 ${rows.length}개 행 검색 중...`);
                
                // 헤더 제외하고 검색 (2행부터)
                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i];
                    if (row.length >= 7) {
                        const rowUsername = row[0];
                        const rowEmail = row[1];
                        const rowPlayDate = row[2];
                        const rowHoleNumber = parseInt(row[6]);
                        
                        // 사용자명, 이메일, 플레이 날짜, 홀 번호가 모두 일치하는지 확인
                        if (rowUsername === username && 
                            rowEmail === email && 
                            rowPlayDate === playDate && 
                            rowHoleNumber === holeNumber) {
                            
                            const foundRowIndex = i + 1; // 1-based index for Google Sheets
                            console.log(`✅ 기존 데이터 발견: 행 ${foundRowIndex}`);
                            return foundRowIndex;
                        }
                    }
                }
                
                console.log('📝 기존 데이터 없음 - 새로 추가됩니다.');
                return 0; // 기존 데이터 없음
                
            } catch (error) {
                console.error('❌ 기존 데이터 검색 실패:', error);
                // 검색 실패 시에도 새로 추가하도록 0 반환
                return 0;
            }
        }
        
        // 요약 업데이트
        function updateSummaries() {
            let frontPar = 0, frontScore = 0, frontRO = 0, front2Put = 0, frontSaved = 0;
            let backPar = 0, backScore = 0, backRO = 0, back2Put = 0, backSaved = 0;
            
            // 전반 9홀 계산
            for (let i = 1; i <= 9; i++) {
                const holeData = golfScoreData[i];
                if (holeData) {
                    frontPar += holeData.par;
                    frontScore += holeData.totalScore;
                    if (holeData.regularOn) frontRO++;
                    if (holeData.twoPut) front2Put++;
                    if (holeData.saved) frontSaved++;
                }
            }
            
            // 후반 9홀 계산
            for (let i = 10; i <= 18; i++) {
                const holeData = golfScoreData[i];
                if (holeData) {
                    backPar += holeData.par;
                    backScore += holeData.totalScore;
                    if (holeData.regularOn) backRO++;
                    if (holeData.twoPut) back2Put++;
                    if (holeData.saved) backSaved++;
                }
            }
            
            // 전체 계산
            const totalPar = frontPar + backPar;
            const totalScore = frontScore + backScore;
            const totalRO = frontRO + backRO;
            const total2Put = front2Put + back2Put;
            const totalSaved = frontSaved + backSaved;
            
            // UI 업데이트 - 전반
            document.getElementById('front-par').textContent = frontPar;
            document.getElementById('front-score').textContent = frontScore;
            document.getElementById('front-diff').textContent = formatParDiff(frontScore - frontPar);
            document.getElementById('front-ro').textContent = frontRO;
            document.getElementById('front-2put').textContent = front2Put;
            document.getElementById('front-saved').textContent = `${frontSaved}/9`;
            
            // UI 업데이트 - 후반
            document.getElementById('back-par').textContent = backPar;
            document.getElementById('back-score').textContent = backScore;
            document.getElementById('back-diff').textContent = formatParDiff(backScore - backPar);
            document.getElementById('back-ro').textContent = backRO;
            document.getElementById('back-2put').textContent = back2Put;
            document.getElementById('back-saved').textContent = `${backSaved}/9`;
            
            // UI 업데이트 - 전체
            document.getElementById('total-par').textContent = totalPar;
            document.getElementById('total-score').textContent = totalScore;
            document.getElementById('total-diff').textContent = formatParDiff(totalScore - totalPar);
            document.getElementById('total-ro').textContent = totalRO;
            document.getElementById('total-2put').textContent = total2Put;
            document.getElementById('total-saved').textContent = `${totalSaved}/18`;
            
            // 파 대비 색상 업데이트
            updateParDiffColors();
        }
        
        // 파 대비 포맷팅
        function formatParDiff(diff) {
            if (diff > 0) return `+${diff}`;
            if (diff < 0) return `${diff}`;
            return 'E';
        }
        
        // 파 대비 색상 업데이트
        function updateParDiffColors() {
            const diffElements = [
                document.getElementById('front-diff'),
                document.getElementById('back-diff'),
                document.getElementById('total-diff')
            ];
            
            diffElements.forEach(element => {
                const text = element.textContent;
                if (text.startsWith('+')) {
                    element.style.color = '#dc3545'; // 오버파 - 빨간색
                } else if (text.startsWith('-')) {
                    element.style.color = '#28a745'; // 언더파 - 녹색
                } else {
                    element.style.color = '#495057'; // 이븐파 - 기본색
                }
            });
        }
        
        // 스코어 계산 (레거시 - 호환성을 위해 유지)
        function calculateScores() {
            updateSummaries();
        }
        
        // 전체 라운드 요약 저장 (기존 기능 유지)
        async function saveGolfScore() {
            showStatus('ℹ️ 새로운 시스템에서는 홀별로 개별 저장됩니다. 각 홀의 "저장" 버튼을 이용해주세요.', 'info');
        }
        
        // Scores 시트 헤더 확인 및 생성
        async function ensureScoresSheetHeaders() {
            try {
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'Scores!A1:W1'
                });
                
                const values = response.result.values;
                
                if (!values || values.length === 0) {
                    console.log('📋 Scores 시트 헤더 생성...');
                    
                    const headers = [
                        'Username', 'Email', 'Play Date', 'Golf Course', 'Tee Box', 'Weather',
                        'Hole 1', 'Hole 2', 'Hole 3', 'Hole 4', 'Hole 5', 'Hole 6', 'Hole 7', 'Hole 8', 'Hole 9',
                        'Hole 10', 'Hole 11', 'Hole 12', 'Hole 13', 'Hole 14', 'Hole 15', 'Hole 16', 'Hole 17', 'Hole 18',
                        'Total Score', 'Completed Holes', 'Created At'
                    ];
                    
                    await gapi.client.sheets.spreadsheets.values.update({
                        spreadsheetId: SPREADSHEET_ID,
                        range: 'Scores!A1:W1',
                        valueInputOption: 'USER_ENTERED',
                        resource: {
                            values: [headers]
                        }
                    });
                    
                    console.log('✅ Scores 시트 헤더 생성 완료');
                }
            } catch (error) {
                console.warn('⚠️ Scores 시트 헤더 처리 중 오류:', error);
                // 헤더 생성 실패는 치명적이지 않으므로 계속 진행
            }
        }
        
        // 골프 스코어 폼 초기화
        function resetGolfScoreForm() {
            // 라운드 정보 초기화
            document.getElementById('golf-course').value = '';
            document.getElementById('play-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('tee-box').value = '화이트';
            document.getElementById('weather').value = '맑음';
            
            // 스코어 초기화
            for (let i = 1; i <= 18; i++) {
                const input = document.getElementById(`hole-${i}`);
                if (input) {
                    input.value = '';
                }
            }
            
            // 요약 초기화
            calculateScores();
        }
        
        // 상태 확인
        function checkStatus() {
            const status = {
                'Google API Script': !!document.querySelector('script[src*="apis.google.com"]'),
                'GIS Script': !!document.querySelector('script[src*="accounts.google.com"]'),
                'window.gapi': !!window.gapi,
                'window.google': !!window.google,
                'System Ready': isReady
            };
            
            let html = '<strong>📊 현재 상태:</strong><br>';
            for (const [key, value] of Object.entries(status)) {
                const icon = value ? '✅' : '❌';
                html += `${icon} ${key}: ${value}<br>`;
            }
            
            showStatus(html, 'debug');
        }
        
        // 강제 초기화
        async function forceInit() {
            initAttempts++;
            showStatus(`🔄 강제 초기화 시도 ${initAttempts}...`, 'info');
            
            try {
                // Google API 스크립트 동적 로딩
                if (!window.gapi) {
                    showStatus('📡 Google API 스크립트 로딩...', 'info');
                    await loadScript('https://apis.google.com/js/api.js');
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
                
                if (!window.google) {
                    showStatus('🔧 Google Identity Services 스크립트 로딩...', 'info');
                    await loadScript('https://accounts.google.com/gsi/client');
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
                
                // GAPI 초기화
                if (window.gapi) {
                    showStatus('⚙️ Google API 클라이언트 초기화...', 'info');
                    await new Promise((resolve, reject) => {
                        gapi.load('client', async () => {
                            try {
                                await gapi.client.init({
                                    discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4']
                                });
                                resolve();
            } catch (error) {
                                reject(error);
                            }
                        });
                    });
                }
                
                // 최종 검증
                if (!window.gapi?.client?.sheets) {
                    throw new Error('Google Sheets API 클라이언트가 초기화되지 않았습니다.');
                }
                
                if (!window.google?.accounts?.oauth2) {
                    throw new Error('Google Identity Services가 초기화되지 않았습니다.');
                }
                
                isReady = true;
                showStatus('✅ 강제 초기화 성공! 이제 회원가입을 시도할 수 있습니다.', 'success');
                
            } catch (error) {
                console.error('❌ 강제 초기화 실패:', error);
                showStatus(`❌ 강제 초기화 실패: ${error.message}`, 'error');
            }
        }
        
        // 스크립트 동적 로딩
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                // 이미 로드된 스크립트인지 확인
                if (document.querySelector(`script[src="${src}"]`)) {
                    resolve();
                return;
            }
            
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = () => reject(new Error(`스크립트 로딩 실패: ${src}`));
                document.head.appendChild(script);
            });
        }
        
        // 로그인 함수
        async function loginUser() {
            const loginBtn = document.getElementById('login-btn');
            
            try {
                // 입력값 검증
                const email = document.getElementById('login-email').value.trim();
                const password = document.getElementById('login-password').value.trim();
                
                if (!email || !password) {
                    showStatus('❌ 이메일과 비밀번호를 입력해주세요.', 'error');
                return;
            }
                
                // 시스템 준비 확인
                if (!isReady) {
                    showStatus('⚠️ 시스템이 준비되지 않았습니다. 강제 초기화를 시도합니다...', 'info');
                    await forceInit();
                    
                    if (!isReady) {
                        throw new Error('시스템 초기화에 실패했습니다.');
                    }
                }
                
                // 버튼 비활성화
                loginBtn.disabled = true;
                loginBtn.textContent = '로그인 중...';
                
                showStatus('🔐 Google 로그인 팝업을 열고 있습니다...', 'info');
                
                // OAuth 토큰 요청
                const tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPE,
                    callback: async (tokenResponse) => {
                        if (tokenResponse.access_token) {
                            try {
                                // 토큰 설정
                                gapi.client.setToken({ access_token: tokenResponse.access_token });
                                
                                showStatus('📋 사용자 정보를 확인하고 있습니다...', 'info');
                                
                                // Google Sheets에서 사용자 조회
                                const response = await gapi.client.sheets.spreadsheets.values.get({
                                    spreadsheetId: SPREADSHEET_ID,
                                    range: 'Users!A:E'
                                });
                                
                                const rows = response.result.values || [];
                                if (rows.length <= 1) {
                                    throw new Error('등록된 사용자가 없습니다. 먼저 회원가입을 해주세요.');
                                }
                                
                                // 사용자 찾기 (헤더 제외)
                                const users = rows.slice(1);
                                const user = users.find(row => 
                                    row[1] && row[1].toLowerCase() === email.toLowerCase() &&
                                    row[2] === password
                                );
                                
                                if (!user) {
                                    throw new Error('이메일 또는 비밀번호가 올바르지 않습니다.');
                                }
                                
                                if (user[4] !== 'active') {
                                    throw new Error('비활성화된 계정입니다.');
                                }
                                
                                // 로그인 성공
                                const loginUserData = {
                                    username: user[0],
                                    email: user[1],
                                    createdAt: user[3]
                                };
                                
                                updateUserUI(loginUserData);
                                console.log('✅ 로그인 성공:', loginUserData);
                                
                            } catch (loginError) {
                                console.error('❌ 로그인 처리 오류:', loginError);
                                showStatus(`❌ 로그인 실패: ${loginError.message}`, 'error');
                            }
                } else {
                            showStatus('❌ Google 로그인 실패', 'error');
                        }
                        
                        loginBtn.disabled = false;
                        loginBtn.textContent = '로그인';
                    }
                });
                
                tokenClient.requestAccessToken({ prompt: 'consent' });
                
            } catch (error) {
                console.error('❌ 로그인 실패:', error);
                showStatus(`❌ 로그인 실패: ${error.message}`, 'error');
                loginBtn.disabled = false;
                loginBtn.textContent = '로그인';
            }
        }
        
        // 회원가입
        async function registerUser() {
            const registerBtn = document.getElementById('register-btn');
            
            try {
                // 입력값 검증
                const username = document.getElementById('register-username').value.trim();
                const email = document.getElementById('register-email').value.trim();
                const password = document.getElementById('register-password').value.trim();
                
                if (!username || !email || !password) {
                    showStatus('❌ 모든 필드를 입력해주세요.', 'error');
                    return;
                }
                
                // 시스템 준비 확인
                if (!isReady) {
                    showStatus('⚠️ 시스템이 준비되지 않았습니다. 강제 초기화를 시도합니다...', 'info');
                    await forceInit();
                    
                    if (!isReady) {
                        throw new Error('시스템 초기화에 실패했습니다.');
                    }
                }
                
                // 버튼 비활성화
                registerBtn.disabled = true;
                registerBtn.textContent = '처리 중...';
                
                showStatus('🔐 Google 로그인 팝업을 열고 있습니다...', 'info');
                
                // OAuth 토큰 요청
                const tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPE,
                    callback: async (tokenResponse) => {
                        if (tokenResponse.access_token) {
                            try {
                                // 토큰 설정
                                gapi.client.setToken({ access_token: tokenResponse.access_token });
                                
                                showStatus('📝 Google Sheets에 데이터를 추가하고 있습니다...', 'info');
                                
                                // 사용자 데이터 추가
                                const newUserData = [
                                    username,
                                    email,
                                    password,
                                    new Date().toISOString(),
                                    'active'
                                ];
                                
                                const response = await gapi.client.sheets.spreadsheets.values.append({
                                    spreadsheetId: SPREADSHEET_ID,
                                    range: 'Users!A:E',
                                    valueInputOption: 'USER_ENTERED',
                                    resource: {
                                        values: [newUserData]
                                    }
                                });
                                
                                console.log('✅ Google Sheets 응답:', response);
                                
                                // 회원가입 성공 후 자동 로그인
                                const registeredUserData = {
                                    username: username,
                                    email: email,
                                    createdAt: new Date().toISOString()
                                };
                                
                                updateUserUI(registeredUserData);
                                console.log('✅ 회원가입 및 자동 로그인 성공:', registeredUserData);
                                
                            } catch (sheetsError) {
                                console.error('❌ Google Sheets 오류:', sheetsError);
                                showStatus(`❌ 데이터 저장 실패: ${sheetsError.message}`, 'error');
                            }
                        } else {
                            showStatus('❌ Google 로그인 실패', 'error');
                        }
                        
                        registerBtn.disabled = false;
                        registerBtn.textContent = '회원가입';
                    }
                });
                
                tokenClient.requestAccessToken({ prompt: 'consent' });
                
                } catch (error) {
                console.error('❌ 회원가입 실패:', error);
                showStatus(`❌ 회원가입 실패: ${error.message}`, 'error');
                registerBtn.disabled = false;
                registerBtn.textContent = '회원가입';
            }
        }
        
        // 페이지 로드 시 자동 초기화
        window.addEventListener('load', () => {
            console.log('🚀 긴급 수정 페이지 로드 완료');
            
            // 3초 후 자동 초기화 시도
            setTimeout(() => {
                if (!isReady) {
                    forceInit();
                }
            }, 3000);
        });
    </script>
</body>
</html>
