<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°„ë‹¨í•œ GIS í…ŒìŠ¤íŠ¸</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; }
        button { padding: 10px 20px; margin: 10px; font-size: 16px; }
        .form-group { margin: 10px 0; }
        input { width: 100%; padding: 8px; margin: 5px 0; }
        .result { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª Google Identity Services í…ŒìŠ¤íŠ¸</h1>
        
        <div class="form-group">
            <h3>íšŒì›ê°€ì… í…ŒìŠ¤íŠ¸</h3>
            <input type="text" id="username" placeholder="ì‚¬ìš©ìëª…" value="testuser4">
            <input type="email" id="email" placeholder="ì´ë©”ì¼" value="test4@example.com">
            <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸" value="password123">
            <button onclick="testRegister()">íšŒì›ê°€ì… í…ŒìŠ¤íŠ¸</button>
        </div>
        
        <div class="form-group">
            <button onclick="checkStatus()">ìƒíƒœ í™•ì¸</button>
            <button onclick="initAPI()">API ì´ˆê¸°í™”</button>
        </div>
        
        <div id="result" class="result" style="display: none;"></div>
    </div>

    <!-- Google API ìŠ¤í¬ë¦½íŠ¸ -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let tokenClient = null;
        let isSignedIn = false;
        let accessToken = null;
        
        const CLIENT_ID = '38824619592-npt5ckpvnqjleo82j7onsrvqi7r39q0h.apps.googleusercontent.com';
        const SCOPE = 'https://www.googleapis.com/auth/spreadsheets';
        const SPREADSHEET_ID = '1-8URFWExJVHp-V3bnB-zFtBaxMZUZ5QKvvEVo0CGz10';
        
        // ê²°ê³¼ í‘œì‹œ í•¨ìˆ˜
        function showResult(message, isError = false) {
            const resultDiv = document.getElementById('result');
            resultDiv.style.display = 'block';
            resultDiv.className = `result ${isError ? 'error' : 'success'}`;
            resultDiv.innerHTML = message;
            console.log(isError ? 'âŒ' : 'âœ…', message);
        }
        
        // ìƒíƒœ í™•ì¸
        function checkStatus() {
            const status = {
                gapi: !!window.gapi,
                google: !!window.google,
                tokenClient: !!tokenClient,
                isSignedIn: isSignedIn,
                accessToken: !!accessToken
            };
            
            console.log('ğŸ“Š í˜„ì¬ ìƒíƒœ:', status);
            showResult(`ìƒíƒœ: ${JSON.stringify(status, null, 2)}`);
        }
        
        // API ì´ˆê¸°í™”
        async function initAPI() {
            try {
                showResult('ğŸš€ API ì´ˆê¸°í™” ì‹œì‘...');
                
                // 1. GAPI ì´ˆê¸°í™”
                if (!window.gapi) {
                    throw new Error('Google APIê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                }
                
                await new Promise((resolve, reject) => {
                    gapi.load('client', async () => {
                        try {
                            await gapi.client.init({
                                discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4']
                            });
                            console.log('âœ… GAPI ì´ˆê¸°í™” ì™„ë£Œ');
                            resolve();
                        } catch (error) {
                            console.error('âŒ GAPI ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                            reject(error);
                        }
                    });
                });
                
                // 2. GIS ì´ˆê¸°í™”
                if (!window.google || !window.google.accounts) {
                    throw new Error('Google Identity Servicesê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                }
                
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPE,
                    callback: (tokenResponse) => {
                        if (tokenResponse.access_token) {
                            console.log('âœ… í† í° íšë“ ì„±ê³µ');
                            accessToken = tokenResponse.access_token;
                            isSignedIn = true;
                            gapi.client.setToken({ access_token: accessToken });
                            showResult('âœ… ë¡œê·¸ì¸ ì„±ê³µ! ì´ì œ íšŒì›ê°€ì…ì„ ì‹œë„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                        } else {
                            console.error('âŒ í† í° íšë“ ì‹¤íŒ¨:', tokenResponse);
                            showResult('âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨', true);
                        }
                    }
                });
                
                showResult('âœ… API ì´ˆê¸°í™” ì™„ë£Œ! ì´ì œ íšŒì›ê°€ì… í…ŒìŠ¤íŠ¸ë¥¼ í•´ë³´ì„¸ìš”.');
                
            } catch (error) {
                console.error('âŒ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                showResult(`âŒ ì´ˆê¸°í™” ì‹¤íŒ¨: ${error.message}`, true);
            }
        }
        
        // ë¡œê·¸ì¸
        async function signIn() {
            if (!tokenClient) {
                throw new Error('í† í° í´ë¼ì´ì–¸íŠ¸ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            }
            
            // ê¸°ì¡´ í† í° í™•ì¸
            const existingToken = gapi.client.getToken();
            if (existingToken && existingToken.access_token) {
                console.log('âœ… ê¸°ì¡´ í† í° ì‚¬ìš©');
                isSignedIn = true;
                accessToken = existingToken.access_token;
                return true;
            }
            
            // ìƒˆ í† í° ìš”ì²­
            console.log('ğŸ” Google ë¡œê·¸ì¸ íŒì—… ìš”ì²­...');
            tokenClient.requestAccessToken({ prompt: 'consent' });
            
            // í† í° íšë“ ëŒ€ê¸°
            return new Promise((resolve) => {
                const checkToken = () => {
                    if (isSignedIn) {
                        resolve(true);
                    } else {
                        setTimeout(checkToken, 1000);
                    }
                };
                checkToken();
            });
        }
        
        // íšŒì›ê°€ì… í…ŒìŠ¤íŠ¸
        async function testRegister() {
            try {
                const username = document.getElementById('username').value;
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                
                if (!username || !email || !password) {
                    showResult('âŒ ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', true);
                    return;
                }
                
                showResult('ğŸš€ íšŒì›ê°€ì… ì‹œì‘...');
                
                // 1. API ì´ˆê¸°í™” (í•„ìš”ì‹œ)
                if (!tokenClient) {
                    await initAPI();
                }
                
                // 2. ë¡œê·¸ì¸
                if (!isSignedIn) {
                    showResult('ğŸ” Google ë¡œê·¸ì¸ í•„ìš”...');
                    await signIn();
                }
                
                if (!isSignedIn) {
                    throw new Error('Google ë¡œê·¸ì¸ì´ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                }
                
                showResult('ğŸ“ Google Sheetsì— ë°ì´í„° ì¶”ê°€ ì¤‘...');
                
                // 3. í—¤ë” í™•ì¸
                try {
                    const headerResponse = await gapi.client.sheets.spreadsheets.values.get({
                        spreadsheetId: SPREADSHEET_ID,
                        range: 'Users!A1:E1'
                    });
                    
                    const values = headerResponse.result.values;
                    if (!values || values.length === 0) {
                        console.log('ğŸ“‹ í—¤ë” ìƒì„±...');
                        await gapi.client.sheets.spreadsheets.values.update({
                            spreadsheetId: SPREADSHEET_ID,
                            range: 'Users!A1:E1',
                            valueInputOption: 'USER_ENTERED',
                            resource: {
                                values: [['Username', 'Email', 'Password', 'Created At', 'Status']]
                            }
                        });
                    }
                } catch (headerError) {
                    console.warn('âš ï¸ í—¤ë” ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ (ê³„ì† ì§„í–‰):', headerError);
                }
                
                // 4. ì‚¬ìš©ì ë°ì´í„° ì¶”ê°€
                const userData = [
                    username,
                    email,
                    password,
                    new Date().toISOString(),
                    'active'
                ];
                
                const response = await gapi.client.sheets.spreadsheets.values.append({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'Users!A:E',
                    valueInputOption: 'USER_ENTERED',
                    resource: {
                        values: [userData]
                    }
                });
                
                console.log('âœ… Google Sheets ì‘ë‹µ:', response);
                showResult(`ğŸ‰ íšŒì›ê°€ì… ì„±ê³µ!<br>ì‚¬ìš©ì: ${username}<br>ì´ë©”ì¼: ${email}<br>ì‹œê°„: ${userData[3]}`);
                
            } catch (error) {
                console.error('âŒ íšŒì›ê°€ì… ì‹¤íŒ¨:', error);
                showResult(`âŒ íšŒì›ê°€ì… ì‹¤íŒ¨: ${error.message}`, true);
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ì´ˆê¸°í™”
        window.addEventListener('load', () => {
            console.log('ğŸš€ í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ - ìë™ ì´ˆê¸°í™” ì‹œì‘');
            setTimeout(initAPI, 1000);
        });
    </script>
</body>
</html>
